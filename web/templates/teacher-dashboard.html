<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления - EduBot</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1759319497">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard {
            padding-top: 80px;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: var(--white);
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .dashboard-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
        }
        
        .dashboard-card h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
            display: block;
        }
        
        .stat-label {
            color: var(--gray-medium);
            font-size: 0.9rem;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .trial-requests {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .request-item {
            padding: 1rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: var(--white);
        }
        
        .request-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .request-name {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .request-date {
            color: var(--gray-medium);
            font-size: 0.9rem;
        }
        
        .request-details {
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .request-phone {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .request-phone i {
            margin-right: 5px;
        }
        
        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
        
        /* Стили для мобильного меню и кнопки "Назад" теперь в style.css */
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <button class="back-btn" onclick="goBack()" title="Назад">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <i class="fas fa-graduation-cap"></i>
                <span>EduBot - Панель управления</span>
            </div>
            <div class="nav-menu">
                <a href="/app" class="nav-link">На главную</a>
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Выйти
                </button>
            </div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/app" class="nav-link">На главную</a>
            <button class="btn btn-outline" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Выйти
            </button>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <h1><i class="fas fa-chalkboard-teacher"></i> Панель управления</h1>
                <p>Добро пожаловать, Александр! Управляйте вашей образовательной платформой.</p>
            </div>
        </div>

        <div class="container">
            <!-- Статистика -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalStudents">0</span>
                    <span class="stat-label">Всего учеников</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="pendingRequests">0</span>
                    <span class="stat-label">Новых заявок</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalAssignments">0</span>
                    <span class="stat-label">Заданий</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalContent">0</span>
                    <span class="stat-label">Материалов</span>
                </div>
            </div>

            <!-- Основной контент -->
            <div class="dashboard-content">
                <!-- Заявки на пробные уроки -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-plus"></i> Заявки на пробные уроки</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-small" onclick="refreshTrialRequests()">
                            <i class="fas fa-sync"></i> Обновить
                        </button>
                        <button class="btn btn-outline btn-small" onclick="markAllAsContacted()">
                            <i class="fas fa-check"></i> Отметить все как связанные
                        </button>
                    </div>
                    <div class="trial-requests" id="trialRequests">
                        <p>Загрузка заявок...</p>
                    </div>
                </div>

                <!-- Быстрые действия -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-tools"></i> Быстрые действия</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="createAssignment()">
                            <i class="fas fa-plus"></i> Создать задание
                        </button>
                        <button class="btn btn-outline" onclick="addContent()">
                            <i class="fas fa-file-alt"></i> Добавить материал
                        </button>
                        <button class="btn btn-outline" onclick="viewStudents()">
                            <i class="fas fa-users"></i> Ученики
                        </button>
                        <button class="btn btn-outline" onclick="window.location.href='/homepage-media'">
                            <i class="fas fa-image"></i> Медиафайлы сайта
                        </button>
                        <button class="btn btn-outline" onclick="window.location.href='/teacher-trial-requests'">
                            <i class="fas fa-calendar-check"></i> Заявки на пробные уроки
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/common.js?v=1759319497"></script>
    <script>
        // Загрузка данных панели управления
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                // Загружаем статистику
                await loadStats();
                
                // Загружаем заявки на пробные уроки
                await loadTrialRequests();
                // Блок «Последние активности» удалён — ничего не загружаем
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Ошибка загрузки данных панели управления', 'error');
            }
        }

        async function loadStats() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                const response = await fetch('/api/teacher/stats', { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalStudents').textContent = data.total_students || 0;
                    document.getElementById('pendingRequests').textContent = data.pending_requests || 0;
                    document.getElementById('totalAssignments').textContent = data.total_assignments || 0;
                    document.getElementById('totalContent').textContent = data.total_content || 0;
                } else {
                    console.error('Failed to load stats:', response.status);
                    // Fallback to default values
                    document.getElementById('totalStudents').textContent = '0';
                    document.getElementById('pendingRequests').textContent = '0';
                    document.getElementById('totalAssignments').textContent = '0';
                    document.getElementById('totalContent').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Fallback to default values
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('pendingRequests').textContent = '0';
                document.getElementById('totalAssignments').textContent = '0';
                document.getElementById('totalContent').textContent = '0';
            }
        }

        async function loadTrialRequests() {
            const container = document.getElementById('trialRequests');
            
            try {
                const token = localStorage.getItem('authToken');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                const response = await fetch('/api/teacher/trial-requests', { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    const requests = data.requests || [];
                    
                    if (requests.length === 0) {
                        container.innerHTML = '<p>Новых заявок нет</p>';
                        return;
                    }

                    container.innerHTML = requests.map(request => {
                        const date = new Date(request.created_at).toLocaleString('ru-RU');
                        return `
                            <div class="request-item">
                                <div class="request-header">
                                    <span class="request-name">${request.name}</span>
                                    <span class="request-date">${date}</span>
                                </div>
                                <div class="request-details">
                                    ${request.grade} класс • ${request.subject} • Уровень ${request.level}
                                </div>
                                <div class="request-details">
                                    ${request.comment || 'Без комментариев'}
                                </div>
                                <div class="request-phone">
                                    ${request.contact_type === 'phone' ? 
                                        '<i class="fas fa-phone"></i> ' + request.contact_value : 
                                        '<i class="fab fa-telegram"></i> <a href="https://t.me/' + request.contact_value.replace('@', '') + '" target="_blank" style="color: #0088cc; text-decoration: none;">' + request.contact_value + '</a>'}
                                    ${request.telegram_id ? 
                                        '<br><i class="fab fa-telegram"></i> <a href="https://t.me/user' + request.telegram_id + '" target="_blank" style="color: #0088cc; text-decoration: none;">ID: ' + request.telegram_id + '</a>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    console.error('Failed to load trial requests:', response.status);
                    container.innerHTML = '<p>Ошибка загрузки заявок</p>';
                }
            } catch (error) {
                console.error('Error loading trial requests:', error);
                container.innerHTML = '<p>Ошибка загрузки заявок</p>';
            }
        }

        // Блок «Последние активности» удалён

        function refreshTrialRequests() {
            loadTrialRequests();
            showNotification('Заявки обновлены', 'success');
        }

        function markAllAsContacted() {
            // Отмечаем все заявки как связанные
            const requestItems = document.querySelectorAll('.request-item');
            requestItems.forEach(item => {
                item.style.opacity = '0.6';
                item.style.backgroundColor = '#f0f0f0';
            });
            showNotification('Все заявки отмечены как связанные', 'success');
        }

        function contactStudent(requestId) {
            showNotification('Функция связи с учеником в разработке', 'info');
        }

        function approveRequest(requestId) {
            showNotification('Заявка одобрена! Ученик будет добавлен в систему.', 'success');
            loadTrialRequests();
        }

        function createAssignment() {
            // Переходим на страницу создания задания
            window.location.href = '/teacher/assignments/create';
        }

        function addContent() {
            // Переходим на страницу добавления материалов
            window.location.href = '/teacher/content/create';
        }

        function generateInviteCode() {
            // Показываем модальное окно с кодом приглашения
            showInviteCodeModal();
        }

        function viewStudents() {
            // Переходим на страницу учеников
            window.location.href = '/teacher/students';
        }

        function showInviteCodeModal() {
            // Создаем модальное окно с кодом приглашения
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Код приглашения</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Используйте этот код для приглашения учеников:</p>
                        <div style="background: var(--gray-light); padding: 1rem; border-radius: var(--border-radius); text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--accent-color); margin: 1rem 0;">
                            EDU2024
                        </div>
                        <p style="font-size: 0.9rem; color: var(--gray-medium);">
                            Поделитесь этим кодом с учениками. Они смогут использовать его для регистрации в системе.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Закрыть</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
